import React, { useState, useRef, useEffect } from ‘react’;
import { Upload, Download, RotateCcw } from ‘lucide-react’;

export default function RetroDitherer() {
const [image, setImage] = useState(null);
const [processedImage, setProcessedImage] = useState(null);
const [brightness, setBrightness] = useState(0);
const [contrast, setContrast] = useState(0);
const [colors, setColors] = useState(4);
const [ditherStrength, setDitherStrength] = useState(128);
const [palette, setPalette] = useState(‘gameboy’);
const canvasRef = useRef(null);
const fileInputRef = useRef(null);

const palettes = {
grayscale: { name: ‘Grayscale’, colors: [’#000000’, ‘#555555’, ‘#aaaaaa’, ‘#ffffff’] },
gameboy: { name: ‘Game Boy’, colors: [’#0f380f’, ‘#306230’, ‘#8bac0f’, ‘#9bbc0f’] },
gameboyPocket: { name: ‘GB Pocket’, colors: [’#2b2b2b’, ‘#525252’, ‘#8a8a8a’, ‘#a4a4a4’] },
virtualBoy: { name: ‘Virtual Boy’, colors: [’#000000’, ‘#550000’, ‘#aa0000’, ‘#ff0000’] },
cga: { name: ‘CGA’, colors: [’#000000’, ‘#00aaaa’, ‘#aa00aa’, ‘#aaaaaa’] },
amber: { name: ‘Amber Monitor’, colors: [’#000000’, ‘#664400’, ‘#cc8800’, ‘#ffaa00’] },
green: { name: ‘Green Monitor’, colors: [’#001100’, ‘#004400’, ‘#00aa00’, ‘#00ff00’] },
blue: { name: ‘Blue Monitor’, colors: [’#000011’, ‘#000044’, ‘#0000aa’, ‘#0000ff’] }
};

const handleImageUpload = (e) => {
const file = e.target.files[0];
if (file) {
const reader = new FileReader();
reader.onload = (event) => {
const img = new Image();
img.onload = () => {
setImage(img);
};
img.src = event.target.result;
};
reader.readAsDataURL(file);
}
};

const hexToRgb = (hex) => {
const result = /^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(hex);
return result ? {
r: parseInt(result[1], 16),
g: parseInt(result[2], 16),
b: parseInt(result[3], 16)
} : null;
};

const applyDither = (imageData, threshold, numColors, paletteColors) => {
const data = imageData.data;
const width = imageData.width;
const height = imageData.height;

```
const colorPalette = paletteColors.map(hex => hexToRgb(hex));

const findClosestColor = (r, g, b) => {
  const gray = 0.299 * r + 0.587 * g + 0.114 * b;
  const normalizedGray = gray / 255;
  const paletteIndex = Math.min(
    Math.floor(normalizedGray * numColors),
    numColors - 1
  );
  
  const segmentSize = colorPalette.length / numColors;
  const colorIndex = Math.min(
    Math.floor(paletteIndex * segmentSize),
    colorPalette.length - 1
  );
  
  return colorPalette[colorIndex];
};

for (let y = 0; y < height; y++) {
  for (let x = 0; x < width; x++) {
    const idx = (y * width + x) * 4;
    
    const oldR = data[idx];
    const oldG = data[idx + 1];
    const oldB = data[idx + 2];
    
    const gray = 0.299 * oldR + 0.587 * oldG + 0.114 * oldB;
    const newColor = findClosestColor(oldR, oldG, oldB);
    
    data[idx] = newColor.r;
    data[idx + 1] = newColor.g;
    data[idx + 2] = newColor.b;
    
    const error = gray - (0.299 * newColor.r + 0.587 * newColor.g + 0.114 * newColor.b);
    
    const spreadError = (dx, dy, factor) => {
      if (x + dx >= 0 && x + dx < width && y + dy >= 0 && y + dy < height) {
        const targetIdx = ((y + dy) * width + (x + dx)) * 4;
        const errorAmount = (error * factor * threshold) / 128;
        data[targetIdx] += errorAmount;
        data[targetIdx + 1] += errorAmount;
        data[targetIdx + 2] += errorAmount;
      }
    };
    
    spreadError(1, 0, 7/16);
    spreadError(-1, 1, 3/16);
    spreadError(0, 1, 5/16);
    spreadError(1, 1, 1/16);
  }
}

return imageData;
```

};

useEffect(() => {
if (!image) return;

```
const canvas = canvasRef.current;
const ctx = canvas.getContext('2d');

const maxWidth = 800;
const maxHeight = 600;
let width = image.width;
let height = image.height;

if (width > maxWidth) {
  height = (height * maxWidth) / width;
  width = maxWidth;
}
if (height > maxHeight) {
  width = (width * maxHeight) / height;
  height = maxHeight;
}

canvas.width = width;
canvas.height = height;

ctx.filter = `brightness(${100 + brightness}%) contrast(${100 + contrast}%)`;
ctx.drawImage(image, 0, 0, width, height);
ctx.filter = 'none';

const imageData = ctx.getImageData(0, 0, width, height);
const dithered = applyDither(imageData, ditherStrength, colors, palettes[palette].colors);
ctx.putImageData(dithered, 0, 0);

setProcessedImage(canvas.toDataURL());
```

}, [image, brightness, contrast, colors, ditherStrength, palette]);

const handleDownload = async () => {
if (!processedImage || !canvasRef.current) return;

```
try {
  const canvas = canvasRef.current;
  
  // Try Web Share API first (works great on mobile)
  if (navigator.share && navigator.canShare) {
    canvas.toBlob(async (blob) => {
      if (!blob) return;
      
      const file = new File([blob], `dithered-${Date.now()}.png`, { type: 'image/png' });
      
      if (navigator.canShare({ files: [file] })) {
        try {
          await navigator.share({
            files: [file],
            title: 'Dithered Image',
            text: 'Check out my dithered image!'
          });
          return;
        } catch (err) {
          if (err.name === 'AbortError') return; // User cancelled
          console.log('Share failed, falling back to download');
        }
      }
      
      // Fallback to download
      downloadImage(blob);
    }, 'image/png');
  } else {
    // Direct download for desktop
    canvas.toBlob((blob) => {
      if (blob) downloadImage(blob);
    }, 'image/png');
  }
} catch (error) {
  console.error('Export failed:', error);
  alert('Failed to export image. Please try again.');
}
```

};

const downloadImage = (blob) => {
const url = URL.createObjectURL(blob);
const link = document.createElement(‘a’);
link.download = `dithered-${Date.now()}.png`;
link.href = url;
link.style.display = ‘none’;
document.body.appendChild(link);

```
// Trigger download
link.click();

// Cleanup
setTimeout(() => {
  document.body.removeChild(link);
  URL.revokeObjectURL(url);
}, 100);
```

};

const handleReset = () => {
setBrightness(0);
setContrast(0);
setColors(4);
setDitherStrength(128);
setPalette(‘gameboy’);
};

return (
<div className="min-h-screen bg-gradient-to-b from-gray-300 to-gray-400 p-4 flex items-center justify-center">
<div className="w-full max-w-6xl flex flex-col lg:flex-row gap-6 items-start">

```
    {/* Game Boy Shell */}
    <div className="w-full lg:w-auto lg:flex-shrink-0">
      <div className="relative bg-gradient-to-br from-gray-200 via-gray-100 to-gray-200 rounded-t-3xl rounded-b-[5rem] p-6 border-8 border-gray-300 max-w-md mx-auto" style={{
        boxShadow: 'inset 0 2px 8px rgba(255,255,255,0.9), inset 0 -2px 8px rgba(0,0,0,0.2), 0 20px 50px rgba(0,0,0,0.4)'
      }}>
      
      {/* Top Section with Logo and Power */}
      <div className="mb-4">
        <div className="flex items-center justify-between mb-2">
          <div className="w-2 h-2 rounded-full bg-red-600" style={{
            boxShadow: 'inset 0 1px 2px rgba(0,0,0,0.5), 0 0 8px rgba(255,0,0,0.5)'
          }}></div>
          <div className="text-[10px] text-gray-500 tracking-widest">◀ POWER</div>
        </div>
        <div className="flex items-start gap-2 mb-1">
          <div className="flex flex-col">
            <div className="text-blue-800 font-black text-2xl tracking-tighter leading-none" style={{ 
              fontFamily: 'Arial Black, sans-serif',
              textShadow: '2px 2px 0px rgba(0,0,0,0.1)'
            }}>
              GAME BOY
            </div>
            <div className="h-0.5 w-16 bg-blue-800 mt-0.5"></div>
          </div>
        </div>
        <div className="text-[9px] text-gray-600 italic -mt-1" style={{ fontFamily: 'serif' }}>
          Nintendo®
        </div>
      </div>

      {/* Screen Bezel */}
      <div className="bg-gradient-to-br from-gray-700 via-gray-800 to-gray-900 rounded-lg p-3 mb-4" style={{
        boxShadow: 'inset 0 4px 12px rgba(0,0,0,0.7), 0 2px 4px rgba(255,255,255,0.2)'
      }}>
        {/* Screen Glass */}
        <div className="bg-gradient-to-br from-purple-900/20 via-transparent to-blue-900/20 rounded p-2">
          {/* LCD Screen */}
          <div className="bg-[#9bbc0f] rounded overflow-hidden relative" style={{ 
            aspectRatio: '10/9',
            boxShadow: 'inset 0 2px 4px rgba(0,0,0,0.3)'
          }}>
            <div className="absolute inset-0 bg-gradient-to-br from-white/5 to-transparent pointer-events-none"></div>
            <div className="w-full h-full flex items-center justify-center p-2">
              {processedImage ? (
                <img 
                  src={processedImage} 
                  alt="Dithered" 
                  className="max-w-full max-h-full object-contain"
                  style={{
                    imageRendering: 'pixelated'
                  }}
                />
              ) : (
                <div className="text-center">
                  <div className="text-[#0f380f] mb-3 text-xs font-bold" style={{ fontFamily: 'monospace' }}>
                    NO CARTRIDGE
                  </div>
                  <button
                    onClick={() => fileInputRef.current?.click()}
                    className="bg-[#0f380f] text-[#9bbc0f] px-4 py-2 rounded font-bold text-xs transition-all"
                    style={{ fontFamily: 'monospace' }}
                  >
                    LOAD IMAGE
                  </button>
                </div>
              )}
            </div>
          </div>
        </div>
        
        {/* DOT MATRIX text */}
        <div className="text-center mt-2 text-[8px] text-gray-400 tracking-[0.3em] font-bold">
          DOT MATRIX WITH STEREO SOUND
        </div>
      </div>

      <input
        ref={fileInputRef}
        type="file"
        accept="image/*"
        onChange={handleImageUpload}
        className="hidden"
      />

      {/* Nintendo Text */}
      <div className="text-center mb-4 text-xs text-gray-600 italic" style={{ fontFamily: 'serif' }}>
        Nintendo GAME BOY™
      </div>

      {/* D-Pad and Buttons Layout */}
      <div className="grid grid-cols-2 gap-8 mb-6 px-4">
        {/* Left: D-Pad Area */}
        <div className="flex items-center justify-center">
          <div className="relative w-24 h-24">
            {/* D-Pad Shadow/Base */}
            <div className="absolute inset-0 flex items-center justify-center">
              <div className="relative">
                {/* Horizontal */}
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-24 h-8 bg-gradient-to-b from-gray-800 to-gray-900 rounded" style={{
                  boxShadow: 'inset 0 -3px 0 rgba(0,0,0,0.5), 0 2px 4px rgba(0,0,0,0.3)'
                }}></div>
                {/* Vertical */}
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-8 h-24 bg-gradient-to-r from-gray-800 to-gray-900 rounded" style={{
                  boxShadow: 'inset 0 -3px 0 rgba(0,0,0,0.5), 0 2px 4px rgba(0,0,0,0.3)'
                }}></div>
                {/* Center circle */}
                <div className="absolute top-1/2 left-1/2 -translate-x-1/2 -translate-y-1/2 w-6 h-6 bg-gray-900 rounded-full"></div>
              </div>
            </div>
          </div>
        </div>

        {/* Right: A/B Buttons */}
        <div className="flex items-center justify-end gap-3 pr-4">
          <div className="flex flex-col items-center gap-1">
            <button className="w-12 h-12 rounded-full bg-gradient-to-b from-purple-700 to-purple-900 shadow-lg relative" style={{
              boxShadow: 'inset 0 -4px 0 rgba(0,0,0,0.4), 0 4px 8px rgba(0,0,0,0.3)'
            }}>
            </button>
            <div className="text-[10px] font-bold text-gray-700">B</div>
          </div>
          <div className="flex flex-col items-center gap-1 -mt-4">
            <button className="w-12 h-12 rounded-full bg-gradient-to-b from-red-600 to-red-800 shadow-lg relative" style={{
              boxShadow: 'inset 0 -4px 0 rgba(0,0,0,0.4), 0 4px 8px rgba(0,0,0,0.3)'
            }}>
            </button>
            <div className="text-[10px] font-bold text-gray-700">A</div>
          </div>
        </div>
      </div>

      {/* Select/Start Buttons */}
      <div className="flex justify-center gap-4 mb-6">
        <div className="flex flex-col items-center gap-1">
          <div className="w-16 h-3 rounded-full bg-gradient-to-b from-gray-600 to-gray-800 shadow-lg" style={{
            boxShadow: 'inset 0 -2px 0 rgba(0,0,0,0.4), 0 2px 4px rgba(0,0,0,0.3)'
          }}></div>
          <div className="text-[8px] font-bold text-gray-600">SELECT</div>
        </div>
        <div className="flex flex-col items-center gap-1">
          <div className="w-16 h-3 rounded-full bg-gradient-to-b from-gray-600 to-gray-800 shadow-lg" style={{
            boxShadow: 'inset 0 -2px 0 rgba(0,0,0,0.4), 0 2px 4px rgba(0,0,0,0.3)'
          }}></div>
          <div className="text-[8px] font-bold text-gray-600">START</div>
        </div>
      </div>

      {/* Speaker */}
      <div className="flex justify-end pr-6 mb-6">
        <div className="grid grid-cols-6 gap-1">
          {[...Array(36)].map((_, i) => (
            <div key={i} className="w-1 h-3 bg-gray-600 rounded-full" style={{
              boxShadow: 'inset 0 1px 1px rgba(0,0,0,0.5)'
            }}></div>
          ))}
        </div>
      </div>

      {/* Bottom Label */}
      <div className="text-center">
        <div className="inline-block bg-gray-600 text-white px-6 py-1 rounded-sm text-[9px] font-bold tracking-wider shadow-lg">
          PHOTO DITHER CARTRIDGE
        </div>
      </div>
      </div>
    </div>

    {/* Control Panel Side by Side with Game Boy */}
    <div className="w-full lg:flex-1 bg-gray-800 rounded-xl p-6 shadow-2xl lg:self-stretch flex flex-col">
      <div className="text-green-400 font-bold mb-4 text-center tracking-wider" style={{ fontFamily: 'monospace' }}>
        ▼ SETTINGS ▼
      </div>
      
      <div className="space-y-4">
        <div>
          <label className="block text-xs font-bold text-green-400 mb-2 tracking-wider" style={{ fontFamily: 'monospace' }}>
            PALETTE
          </label>
          <select
            value={palette}
            onChange={(e) => setPalette(e.target.value)}
            className="w-full bg-gray-900 text-green-400 px-3 py-2 rounded border-2 border-green-600 focus:border-green-400 focus:outline-none text-xs font-bold"
            style={{ fontFamily: 'monospace' }}
          >
            {Object.entries(palettes).map(([key, pal]) => (
              <option key={key} value={key}>{pal.name}</option>
            ))}
          </select>
          <div className="flex gap-1 mt-2">
            {palettes[palette].colors.map((color, i) => (
              <div key={i} className="flex-1 h-6 rounded border border-gray-700" style={{ backgroundColor: color }}></div>
            ))}
          </div>
        </div>

        <div>
          <label className="block text-xs font-bold text-green-400 mb-2 tracking-wider" style={{ fontFamily: 'monospace' }}>
            COLORS: {colors}
          </label>
          <input
            type="range"
            min="2"
            max="16"
            value={colors}
            onChange={(e) => setColors(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-900 rounded appearance-none cursor-pointer"
            style={{ accentColor: '#9bbc0f' }}
          />
        </div>

        <div>
          <label className="block text-xs font-bold text-green-400 mb-2 tracking-wider" style={{ fontFamily: 'monospace' }}>
            DITHER: {ditherStrength}
          </label>
          <input
            type="range"
            min="0"
            max="255"
            value={ditherStrength}
            onChange={(e) => setDitherStrength(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-900 rounded appearance-none cursor-pointer"
            style={{ accentColor: '#9bbc0f' }}
          />
        </div>

        <div>
          <label className="block text-xs font-bold text-green-400 mb-2 tracking-wider" style={{ fontFamily: 'monospace' }}>
            BRIGHT: {brightness > 0 ? '+' : ''}{brightness}
          </label>
          <input
            type="range"
            min="-50"
            max="50"
            value={brightness}
            onChange={(e) => setBrightness(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-900 rounded appearance-none cursor-pointer"
            style={{ accentColor: '#9bbc0f' }}
          />
        </div>

        <div>
          <label className="block text-xs font-bold text-green-400 mb-2 tracking-wider" style={{ fontFamily: 'monospace' }}>
            CONTRAST: {contrast > 0 ? '+' : ''}{contrast}
          </label>
          <input
            type="range"
            min="-50"
            max="50"
            value={contrast}
            onChange={(e) => setContrast(parseInt(e.target.value))}
            className="w-full h-2 bg-gray-900 rounded appearance-none cursor-pointer"
            style={{ accentColor: '#9bbc0f' }}
          />
        </div>

        {processedImage && (
          <div className="grid grid-cols-2 gap-3 pt-2">
            <button
              onClick={() => fileInputRef.current?.click()}
              className="bg-green-600 hover:bg-green-500 text-black px-4 py-3 rounded font-bold text-xs transition-all"
              style={{ fontFamily: 'monospace' }}
            >
              <Upload className="w-4 h-4 inline mr-1" />
              NEW
            </button>
            <button
              onClick={handleDownload}
              className="bg-green-600 hover:bg-green-500 text-black px-4 py-3 rounded font-bold text-xs transition-all"
              style={{ fontFamily: 'monospace' }}
            >
              <Download className="w-4 h-4 inline mr-1" />
              SAVE
            </button>
          </div>
        )}

        <button
          onClick={handleReset}
          className="w-full bg-gray-700 hover:bg-gray-600 text-green-400 px-4 py-2 rounded font-bold text-xs transition-all"
          style={{ fontFamily: 'monospace' }}
        >
          <RotateCcw className="w-3 h-3 inline mr-1" />
          RESET
        </button>
      </div>
    </div>

    <canvas ref={canvasRef} className="hidden" />
  </div>
</div>
```

);
}
